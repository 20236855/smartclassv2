# 视频知识点抽取问题排查指南

## 问题1：数据库错误 - Field 'creator_id' doesn't have a default value

### 错误信息
```
java.sql.SQLException: Field 'creator_id' doesn't have a default value
```

### 原因
在异步任务中无法获取当前用户ID（`SecurityUtils.getUserId()`），且没有设置默认值。

### 解决方案
已在代码中添加默认值处理：

```java
try {
    kg.setCreatorId(SecurityUtils.getUserId());
} catch (Exception e) {
    kg.setCreatorId(1L); // 使用默认用户ID
    logger.warn("无法获取当前用户ID以设置 creatorId，使用默认值 1：{}", e.getMessage());
}
```

### 验证
重新生成知识图谱，检查日志中是否有警告信息，但不应该再有错误。

---

## 问题2：视频抽取返回0个知识点

### 错误信息
```
AI返回的candidates数量：0
从视频AI抽取到 0 个知识点，0 条关系
```

### 可能原因

#### 原因1：视频描述太短或为空
AI需要足够的文本才能抽取知识点。

**检查方法**：
```sql
SELECT id, title, description, LENGTH(description) as desc_length 
FROM video 
WHERE course_id = 33;
```

**解决方案**：
- 确保视频有详细的描述
- 描述应包含具体的知识点、概念、术语
- 建议描述长度至少50个字符

**示例**：
```sql
-- ❌ 不好的描述
UPDATE video SET description = '入门视频' WHERE id = 1;

-- ✅ 好的描述
UPDATE video SET description = '本视频讲解Java面向对象编程的核心概念，包括类的定义、对象的创建、继承关系、多态性的实现，以及封装的重要性。通过实例演示如何使用继承实现代码复用，如何通过多态实现灵活的程序设计。' WHERE id = 1;
```

#### 原因2：文本格式问题
之前的版本使用"视频"、"标题"、"描述"等标签，与AI的提示词不匹配。

**已修复**：
现在使用与题目相同的格式：
```java
allVideosText.append("=== 题目 ").append(video.getId()).append(" ===\n");
if (video.getTitle() != null) allVideosText.append("题干: ").append(video.getTitle()).append("\n");
if (video.getDescription() != null) allVideosText.append("解析: ").append(video.getDescription()).append("\n");
```

#### 原因3：AI API配置问题
检查千问API是否正常工作。

**检查方法**：
查看日志中的API调用信息：
```
调用 Qianwen 接口（含关系抽取）: https://api.siliconflow.cn/v1/chat/completions
```

**验证API**：
```bash
curl -X POST https://api.siliconflow.cn/v1/chat/completions \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "Qwen/QwQ-32B",
    "messages": [{"role": "user", "content": "你好"}]
  }'
```

---

## 问题3：知识点重复

### 现象
生成的知识图谱中出现重复的知识点。

### 原因
去重逻辑基于知识点名称的完全匹配，如果名称略有不同（如"面向对象"和"面向对象编程"），会被视为不同的知识点。

### 当前去重逻辑
```java
Map<String, Map<String,Object>> uniqueKps = new LinkedHashMap<>();
for (Map<String,Object> kp : allKps) {
    String name = kp.getOrDefault("name", "").toString().trim();
    if (!name.isEmpty() && !uniqueKps.containsKey(name)) {
        uniqueKps.put(name, kp);
    }
}
```

### 改进建议（未实现）
可以使用更智能的去重算法：
1. **字符串相似度**：使用Jaccard相似度或编辑距离
2. **语义相似度**：使用词向量计算相似度
3. **规则匹配**：定义同义词规则

---

## 问题4：章节图谱包含其他章节的视频

### 现象
生成章节图谱时，包含了整个课程的视频数据。

### 原因
Video表没有 `chapter_id` 字段，无法按章节过滤视频。

### 当前实现
```java
com.ruoyi.system.domain.Video videoQuery = new com.ruoyi.system.domain.Video();
videoQuery.setCourseId(courseId);
// 注意：Video表可能没有chapterId字段，这里只能按courseId查询
java.util.List<com.ruoyi.system.domain.Video> videos = videoService.selectVideoList(videoQuery);
```

### 解决方案（需要数据库改动）
1. 在Video表添加 `chapter_id` 字段
2. 修改查询逻辑：
```java
videoQuery.setCourseId(courseId);
videoQuery.setChapterId(chapterId); // 添加章节过滤
```

---

## 调试技巧

### 1. 查看完整的AI输入文本
在调用AI之前，打印完整的输入文本：

```java
logger.info("AI输入文本：\n{}", allVideosText.toString());
```

### 2. 查看AI返回的原始JSON
在 `AiExtractionService` 中添加日志：

```java
logger.info("AI返回的原始JSON：{}", resp);
```

### 3. 测试单个视频
创建一个测试方法，只处理一个视频：

```java
@Test
public void testSingleVideo() {
    String text = "=== 题目 1 ===\n题干: Java面向对象编程\n解析: 本视频讲解Java的类、对象、继承、多态等核心概念\n\n";
    Map<String,Object> result = aiExtractionService.extractKnowledgePointsWithRelations(text);
    System.out.println(result);
}
```

### 4. 检查数据库中的视频数据
```sql
-- 查看课程的所有视频
SELECT id, title, description, LENGTH(description) as desc_len
FROM video
WHERE course_id = 33
ORDER BY id;

-- 查看视频描述的详细内容
SELECT id, title, description
FROM video
WHERE course_id = 33 AND id = 1;
```

### 5. 查看生成的知识点
```sql
-- 查看课程的所有知识点
SELECT id, title, description, course_id, created_at
FROM knowledge_point
WHERE course_id = 33
ORDER BY created_at DESC;

-- 查看知识点关系
SELECT 
    kp1.title as from_kp,
    kp2.title as to_kp,
    kr.relation_type
FROM kp_relation kr
JOIN knowledge_point kp1 ON kr.from_kp_id = kp1.id
JOIN knowledge_point kp2 ON kr.to_kp_id = kp2.id
WHERE kp1.course_id = 33;
```

---

## 性能优化建议

### 1. 批量大小控制
如果视频数量很多（>50个），建议分批处理：

```java
int batchSize = 20;
for (int i = 0; i < videos.size(); i += batchSize) {
    List<Video> batch = videos.subList(i, Math.min(i + batchSize, videos.size()));
    // 处理这一批视频
}
```

### 2. 缓存AI结果
对于相同的视频内容，可以缓存AI的抽取结果，避免重复调用。

### 3. 异步处理
当前已经使用 `@Async` 异步处理，但可以进一步优化：
- 使用消息队列（如RabbitMQ）
- 添加进度反馈机制
- 支持取消任务

---

## 问题5：生成的章节不对（生成了第10章，但我选的是第1章）

### 现象
点击"重新生成"按钮时，后端日志显示生成的是第10章，但用户明明选择的是第1章。

### 原因
前端的 `selectedChapterId` 保留了之前的值。可能的情况：
1. 用户之前选择了第10章
2. 切换到其他页面或刷新页面
3. 再次进入时，`selectedChapterId` 还是之前的值

### 解决方案（已修复）

#### 修复1：添加章节选择验证
在生成前检查是否选择了章节：

```javascript
handleGenerate() {
  // 如果是章节图谱但没有选择章节，提示用户
  if (this.selectedGraphType === 'CHAPTER' && !this.selectedChapterId) {
    this.$message.warning('请先选择章节')
    return
  }

  // 显示当前生成的是哪个章节
  if (this.selectedGraphType === 'CHAPTER') {
    const chapter = this.chapterList.find(c => c.id === this.selectedChapterId)
    const chapterTitle = chapter ? chapter.title : `章节${this.selectedChapterId}`
    console.log(`正在生成章节图谱：courseId=${this.courseId}, chapterId=${this.selectedChapterId}, title=${chapterTitle}`)
    this.$message.info(`正在生成"${chapterTitle}"的知识图谱...`)
  }
  // ...
}
```

#### 修复2：自动选择第一个章节
当切换到章节模式时，自动选择第一个章节：

```javascript
handleTypeChange() {
  this.selectedChapterId = null
  // 如果切换到章节模式且有章节数据，自动选择第一个
  if (this.selectedGraphType === 'CHAPTER' && this.chapterList.length > 0) {
    this.selectedChapterId = this.chapterList[0].id
    console.log(`切换到章节模式，自动选择第一个章节：id=${this.selectedChapterId}`)
  }
  this.loadGraph()
}
```

### 验证方法

1. **查看浏览器控制台**
   - 打开浏览器开发者工具（F12）
   - 切换到 Console 标签
   - 点击"重新生成"按钮
   - 应该看到类似的日志：
     ```
     正在生成章节图谱：courseId=33, chapterId=1, title=第一章
     ```

2. **查看前端提示**
   - 点击"重新生成"按钮
   - 应该看到提示："正在生成"第一章"的知识图谱..."
   - 而不是之前的通用提示

3. **查看后端日志**
   - 后端日志应该显示：
     ```
     开始生成章节知识图谱：courseId=33, chapterId=1
     ```
   - 确认 `chapterId` 与前端选择的一致

### 使用建议

1. **明确选择章节**
   - 切换到"章节图谱"模式后
   - 在下拉框中明确选择要生成的章节
   - 确认下拉框显示的是正确的章节名称

2. **查看提示信息**
   - 点击"重新生成"后，注意查看提示信息
   - 确认提示的章节名称是否正确

3. **使用浏览器控制台**
   - 如果不确定，打开浏览器控制台查看日志
   - 日志会显示实际传递的参数

---

## 常见问题FAQ

### Q1: 为什么视频文本使用"题干"和"解析"标签？
**A:** 因为AI的提示词是为题目设计的，使用相同的格式可以复用现有的提示词，提高抽取成功率。这是一个权衡方案，避免修改AI提示词。

### Q2: 可以从视频字幕中抽取知识点吗？
**A:** 可以，但需要额外的工作：
1. 集成语音识别服务（如阿里云、腾讯云）
2. 提取视频字幕文本
3. 将字幕文本传入AI抽取服务

### Q3: 如何提高抽取的准确率？
**A:** 
1. 提供更详细的视频描述
2. 在描述中明确列出知识点
3. 使用规范的术语和概念
4. 优化AI提示词（需要修改 `AiExtractionService`）

### Q4: 生成失败后如何重试？
**A:** 
1. 在前端点击"重新生成"按钮
2. 或调用API：`POST /system/graph/extract/course/{courseId}`
3. 系统会重新处理所有数据

---

**祝排查顺利！** 🔍


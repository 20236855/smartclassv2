# 知识图谱功能实现总结

## 已完成的功能

### 1. 后端功能 ✅

#### 1.1 AI 知识点和关系抽取
- **文件**: `AiExtractionService.java`
- **功能**:
  - ✅ 调用千问 API 抽取知识点（名称、定义、置信度）
  - ✅ 抽取知识点之间的关系（prerequisite、uses、related_method、similar）
  - ✅ 支持长文本分片处理
  - ✅ 本地正则表达式回退方案（当 AI 不可用时）
  - ✅ 新增 `extractKnowledgePointsWithRelations()` 方法

#### 1.2 知识点和关系保存到数据库
- **文件**: `KnowledgeGraphServiceImpl.java`
- **功能**:
  - ✅ 从题库抽取知识点并保存到 `knowledge_point` 表
  - ✅ 抽取知识点关系并保存到 `kp_relation` 表
  - ✅ 自动去重（按知识点名称）
  - ✅ 建立 name -> id 映射，确保关系正确关联
  - ✅ 根据置信度自动设置难度等级（high/medium/low）
  - ✅ 标记 AI 生成的关系（ai_generated = 1）
  - ✅ 生成课程级知识图谱
  - ✅ 生成章节级知识图谱（新增 `generateChapterGraph()` 方法）

#### 1.3 REST API 接口
- **文件**: `KnowledgeGraphController.java`
- **接口**:
  - ✅ `POST /system/graph/extract/course/{courseId}` - 生成课程知识图谱
  - ✅ `POST /system/graph/extract/chapter/{courseId}/{chapterId}` - 生成章节知识图谱（新增）
  - ✅ `GET /system/graph/list` - 查询知识图谱列表
  - ✅ `GET /system/graph/{id}` - 查询知识图谱详情

### 2. 前端功能 ✅

#### 2.1 知识图谱可视化页面
- **文件**: `ruoyi-ui/src/views/system/graph/visualize.vue`
- **功能**:
  - ✅ 基于 ECharts 的力导向图可视化
  - ✅ 课程和章节选择器
  - ✅ 一键加载知识图谱
  - ✅ 一键生成知识图谱
  - ✅ 导出图片功能
  - ✅ 节点点击查看详情
  - ✅ 节点大小根据置信度动态调整
  - ✅ 节点颜色根据置信度分级（绿/橙/红）
  - ✅ 边的颜色根据关系类型区分
  - ✅ 支持缩放、平移、拖拽
  - ✅ 关系高亮显示

#### 2.2 API 接口封装
- **文件**: `ruoyi-ui/src/api/system/graph.js`
- **功能**:
  - ✅ 新增 `extractChapterGraph()` 接口

#### 2.3 路由配置
- **文件**: `ruoyi-ui/src/router/index.js`
- **功能**:
  - ✅ 添加 `/system/graph/visualize` 路由

#### 2.4 管理页面增强
- **文件**: `ruoyi-ui/src/views/system/graph/index.vue`
- **功能**:
  - ✅ 添加"知识图谱可视化"按钮

### 3. 文档 ✅

- ✅ `README_KG_RELATIONS.md` - 知识图谱关系抽取功能说明
- ✅ `知识图谱可视化使用指南.md` - 快速使用指南
- ✅ `sql/test_knowledge_graph.sql` - 测试数据脚本
- ✅ `知识图谱功能实现总结.md` - 本文档

## 技术架构

### 后端技术栈
- Spring Boot 2.x
- MyBatis
- RestTemplate（调用千问 API）
- Jackson（JSON 解析）
- 异步任务处理（@Async）

### 前端技术栈
- Vue 2.x
- Element UI
- ECharts 5.x
- Axios

### 数据库表
- `knowledge_point` - 知识点表
- `kp_relation` - 知识点关系表
- `knowledge_graph` - 知识图谱表
- `question` - 题目表

## 数据流程

```
题库数据 (question)
    ↓
AI 抽取服务 (AiExtractionService)
    ↓
知识点 + 关系 (JSON)
    ↓
知识图谱服务 (KnowledgeGraphServiceImpl)
    ↓
保存到数据库 (knowledge_point + kp_relation)
    ↓
生成图谱数据 (knowledge_graph.graph_data)
    ↓
前端可视化 (ECharts)
```

## 核心代码文件清单

### 后端
```
ruoyi-system/src/main/java/com/ruoyi/system/
├── service/impl/
│   ├── AiExtractionService.java          # AI 抽取服务（已修改）
│   └── KnowledgeGraphServiceImpl.java    # 知识图谱服务（已修改）
├── service/
│   └── IKnowledgeGraphService.java       # 服务接口（已修改）
└── domain/
    ├── KnowledgePoint.java               # 知识点实体
    ├── KpRelation.java                   # 知识点关系实体
    └── KnowledgeGraph.java               # 知识图谱实体

ruoyi-admin/src/main/java/com/ruoyi/web/controller/system/
└── KnowledgeGraphController.java         # 控制器（已修改）
```

### 前端
```
ruoyi-ui/src/
├── views/system/graph/
│   ├── index.vue                         # 管理页面（已修改）
│   └── visualize.vue                     # 可视化页面（新增）
├── api/system/
│   └── graph.js                          # API 接口（已修改）
└── router/
    └── index.js                          # 路由配置（已修改）
```

## 使用示例

### 1. 生成知识图谱

```bash
# 生成课程知识图谱
curl -X POST http://localhost:8080/system/graph/extract/course/33

# 生成章节知识图谱
curl -X POST http://localhost:8080/system/graph/extract/chapter/33/1
```

### 2. 查看知识点

```sql
SELECT * FROM knowledge_point WHERE course_id = 33;
```

### 3. 查看知识点关系

```sql
SELECT 
    kp1.title AS source,
    kp2.title AS target,
    r.relation_type
FROM kp_relation r
JOIN knowledge_point kp1 ON r.from_kp_id = kp1.id
JOIN knowledge_point kp2 ON r.to_kp_id = kp2.id
WHERE kp1.course_id = 33;
```

### 4. 前端可视化

访问：http://localhost/system/graph/visualize

## 测试步骤

1. **导入测试数据**
   ```bash
   mysql -u root -p ry-vue < sql/test_knowledge_graph.sql
   ```

2. **启动后端**
   ```bash
   cd ruoyi-admin
   mvn spring-boot:run
   ```

3. **启动前端**
   ```bash
   cd ruoyi-ui
   npm run dev
   ```

4. **生成知识图谱**
   - 访问：http://localhost/system/graph
   - 点击"知识图谱可视化"
   - 选择课程 33，章节 1
   - 点击"生成知识图谱"

5. **查看可视化**
   - 等待 3-5 秒
   - 点击"加载知识图谱"
   - 查看交互式知识图谱

## 下一步优化建议

1. **知识点合并** - 处理同义词和相似知识点
2. **关系权重** - 为关系添加权重，表示关联强度
3. **知识点推荐** - 基于学生掌握情况推荐学习路径
4. **手动编辑** - 支持手动添加/编辑/删除知识点和关系
5. **版本管理** - 知识图谱的版本控制和历史回溯
6. **对比分析** - 对比不同章节或课程的知识图谱
7. **导出功能** - 导出为 Neo4j、GraphML 等格式
8. **性能优化** - 大规模知识图谱的渲染优化

## 注意事项

1. 确保配置了千问 API（否则使用本地回退方案）
2. 异步任务需要等待几秒才能完成
3. 知识点去重基于名称，可能需要手动合并同义词
4. 关系抽取依赖 AI 质量，可能需要人工审核
5. 大规模图谱可能影响前端渲染性能

## 联系方式

如有问题，请查看日志或联系开发团队。


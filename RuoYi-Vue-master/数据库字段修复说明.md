# 数据库字段修复说明

## 问题总结

在实现知识图谱功能时，遇到了两个数据库字段相关的错误：

### 错误 1: level 字段数据截断
```
Data truncated for column 'level' at row 1
```

**原因**：数据库中 `level` 字段定义为枚举类型 `enum('BASIC','INTERMEDIATE','ADVANCED')`，但代码中尝试插入字符串值 `"high"`、`"medium"`、`"low"`。

**解决方案**：修改代码，使用正确的枚举值。

### 错误 2: creator_user_id 字段缺少默认值
```
Field 'creator_user_id' doesn't have a default value
```

**原因**：
1. 数据库中 `creator_user_id` 字段定义为 `NOT NULL`，必须提供值
2. 异步任务中无法通过 `SecurityUtils.getUserId()` 获取当前用户 ID
3. 该字段有外键约束，必须引用 `user` 表中存在的记录

**解决方案**：在异步任务中捕获异常后，使用默认用户 ID（1 = admin）。

## 新发现的问题 3: relation_type 字段数据截断

### 错误信息
```
Data truncated for column 'relation_type' at row 1
```

**原因**：
- `kp_relation.relation_type` 字段是枚举类型：`enum('prerequisite','parallel','extension')`
- AI 返回的关系类型可能是中文或其他格式，如："前置关系"、"依赖"、"相关"等
- 这些值不在枚举范围内，导致数据截断错误

**解决方案**：
添加关系类型映射函数，将 AI 返回的各种关系类型映射到数据库枚举值。

### 映射规则

| AI 可能返回的值 | 映射到数据库枚举 | 说明 |
|---------------|----------------|------|
| prerequisite, 前置, 依赖, requires, depends, 基础 | `prerequisite` | 前置关系 |
| parallel, 并行, 同级, concurrent, 同时, 相关 | `parallel` | 并行关系 |
| extension, 扩展, 延伸, advanced, 进阶, 深入 | `extension` | 扩展关系 |
| 其他未识别的值 | `prerequisite` | 默认值 |

### 修复代码

```java
// 添加映射方法
private String mapRelationType(String aiRelationType) {
    if (aiRelationType == null) {
        return "prerequisite";
    }
    
    String type = aiRelationType.toLowerCase().trim();
    
    if (type.contains("prerequisite") || type.contains("前置") || type.contains("依赖")) {
        return "prerequisite";
    }
    if (type.contains("parallel") || type.contains("并行") || type.contains("相关")) {
        return "parallel";
    }
    if (type.contains("extension") || type.contains("扩展") || type.contains("进阶")) {
        return "extension";
    }
    
    return "prerequisite"; // 默认值
}

// 在关系保存时使用映射
String mappedRelationType = mapRelationType(relationType);
kpRelation.setRelationType(mappedRelationType);
```

## 修复详情

### 1. level 字段值映射

| 置信度范围 | 旧值（错误） | 新值（正确） | 说明 |
|-----------|------------|------------|------|
| ≥ 0.7 | "high" | "BASIC" | 基础知识点 |
| 0.4-0.7 | "medium" | "INTERMEDIATE" | 中级知识点 |
| < 0.4 | "low" | "ADVANCED" | 高级知识点 |

**逻辑说明**：置信度越高，说明知识点越基础/简单。

### 2. creator_user_id 字段处理

```java
// 修复前（会导致错误）
try {
    kp.setCreatorUserId(SecurityUtils.getUserId());
} catch (Exception e) {
    logger.warn("无法获取当前用户ID：{}", e.getMessage());
    // 没有设置默认值，导致字段为 null
}

// 修复后（正确）
try {
    kp.setCreatorUserId(SecurityUtils.getUserId());
} catch (Exception e) {
    logger.warn("无法获取当前用户ID，使用默认值 1：{}", e.getMessage());
    kp.setCreatorUserId(1L); // 使用默认用户 ID
}
```

## 数据库表结构

### knowledge_point 表

```sql
CREATE TABLE `knowledge_point` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `course_id` bigint NOT NULL COMMENT '所属课程',
  `title` varchar(200) NOT NULL COMMENT '知识点名称',
  `description` text NULL COMMENT '详细解释（AI生成）',
  `level` enum('BASIC','INTERMEDIATE','ADVANCED') NULL DEFAULT 'BASIC' COMMENT '难度',
  `creator_user_id` bigint NOT NULL COMMENT '创建者 user.id',
  `create_time` datetime NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `is_deleted` tinyint(1) NULL DEFAULT 0,
  `delete_time` datetime NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  CONSTRAINT `fk_kp_creator` FOREIGN KEY (`creator_user_id`) REFERENCES `user` (`id`)
) ENGINE = InnoDB;
```

**关键点**：
1. `level` 字段是枚举类型，只能是 `BASIC`、`INTERMEDIATE` 或 `ADVANCED`
2. `creator_user_id` 字段是 `NOT NULL`，必须提供值
3. `creator_user_id` 有外键约束，必须引用 `user` 表中存在的 id

## 修改的文件

1. **KnowledgeGraphServiceImpl.java**
   - 修改 `generateCourseGraph()` 方法（第 190-212 行）
   - 修改 `generateChapterGraph()` 方法（第 369-391 行）

2. **README_KG_RELATIONS.md**
   - 更新 level 字段说明
   - 添加 creator_user_id 字段说明

## 验证步骤

### 1. 检查数据库中是否存在默认用户

```sql
-- 检查 user 表中是否存在 id=1 的记录
SELECT * FROM user WHERE id = 1;

-- 如果不存在，需要创建
INSERT INTO user (id, sys_user_id, username, password, email, nick_name, role, status, create_time)
VALUES (1, 1, 'admin', '$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE8ByOhJIrdAu2', 
        'admin@example.com', '系统管理员', 'ADMIN', 'ACTIVE', NOW());
```

### 2. 重新编译和启动

```bash
# 重新编译
cd ruoyi-admin
mvn clean compile

# 重启服务
mvn spring-boot:run
```

### 3. 测试知识点生成

```bash
# 生成课程知识图谱
curl -X POST http://localhost:8080/system/graph/extract/course/33

# 等待 5 秒后查询数据库
mysql -u root -p -e "SELECT id, title, level, creator_user_id FROM knowledge_point WHERE course_id = 33;" ry-vue
```

**预期结果**：
- 知识点成功保存到数据库
- `level` 字段值为 `BASIC`、`INTERMEDIATE` 或 `ADVANCED`
- `creator_user_id` 字段值为 1（或当前登录用户的 ID）

## 常见问题

### Q1: 如果数据库中不存在 id=1 的用户怎么办？

**A:** 有两种解决方案：

**方案 1**：创建默认用户（推荐）
```sql
INSERT INTO user (id, sys_user_id, username, password, email, nick_name, role, status, create_time)
VALUES (1, 1, 'system', '$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE8ByOhJIrdAu2', 
        'system@example.com', '系统用户', 'ADMIN', 'ACTIVE', NOW());
```

**方案 2**：修改代码使用其他存在的用户 ID
```java
kp.setCreatorUserId(19L); // 使用其他存在的用户 ID
```

### Q2: 为什么异步任务中无法获取当前用户 ID？

**A:** 
- Spring Security 的用户信息存储在 `ThreadLocal` 中
- 异步任务在新的线程中执行，无法访问原线程的 `ThreadLocal` 数据
- 因此 `SecurityUtils.getUserId()` 会抛出异常

### Q3: 能否修改数据库表结构，让 creator_user_id 允许为 NULL？

**A:** 不推荐。原因：
1. 破坏了数据完整性约束
2. 无法追踪知识点的创建者
3. 可能影响其他依赖该字段的功能

更好的做法是使用系统默认用户 ID。

## 总结

修复后的代码：
- ✅ 使用正确的枚举值（BASIC/INTERMEDIATE/ADVANCED）
- ✅ 在异步任务中提供默认的 creator_user_id
- ✅ 保持数据库约束的完整性
- ✅ 不需要修改数据库表结构

现在知识点可以正常保存到数据库了！




